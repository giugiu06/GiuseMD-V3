import '@whiskeysockets/baileys';
import fetch from 'node-fetch'; // Necessario per fetchare le immagini

let handler = async (m, { conn, usedPrefix }) => {
    // Estrai lo stato di TUTTE le funzionalitÃ  dalla configurazione della chat
    // Assicurati che global.db.data.chats[m.chat] esista e contenga queste proprietÃ .
    // Ãˆ buona pratica fornire un valore di fallback (es. false) se non garantito.
    const chatSettings = global.db.data.chats[m.chat] || {};

    const {
        antiToxic = false,
        antilinkhard = false,
        antiPrivate = false,
        antitraba = false,
        antiArab = false,
        antiviewonce = false,
        isBanned = false, 
        welcome = false,
        detect = false,
        sWelcome = false, 
        sBye = false,
        sPromote = false,
        sDemote = false,
        antiLink = false,
        antilinkbase = false,
        antitiktok = false,
        sologruppo = false,
        soloprivato = false,
        antiCall = false,
        modohorny = false,
        gpt = false,
        antiinsta = false,
        antielimina = false,
        antitelegram = false,
        antiSpam = false,
        antiPorno = false,
        jadibot = false,
        autosticker = false,
        modoadmin = false,
        audios = false
    } = chatSettings;

    // Prepara la thumbnail per l'embed
    // Assicurati che l'URL sia valido e accessibile.
    const thumbnail = await (await fetch("https://qu.ax/cSqEs.jpg")).buffer().catch(() => Buffer.from('')); 

    // Prepara il nome del bot per il footer della newsletter
    const botNewsletterName = ' GiuseMD-V3 â†’ Funzioni ';
    const newsletterJid = "120363419284785624@newsletter"; // Il JID del tuo canale/newsletter

    // Costruisci il testo del menu con lo stile minimalista
    let menuText = `âš™ï¸ *STATO DELLE FUNZIONALITÃ€* âš™ï¸

${detect ? 'âœ…' : 'âŒ'} *detect* ğŸ”
${gpt ? 'âœ…' : 'âŒ'} *gpt* ğŸ¤–
${welcome ? 'âœ…' : 'âŒ'} *welcome* ğŸ‘‹ğŸ»
${sologruppo ? 'âœ…' : 'âŒ'} *sologruppo* ğŸ‘¥
${soloprivato ? 'âœ…' : 'âŒ'} *soloprivato* ğŸ‘¤
${modoadmin ? 'âœ…' : 'âŒ'} *modoadmin* ğŸ‘‘
${antiCall ? 'âœ…' : 'âŒ'} *antiCall* ğŸ“µ
${antiLink ? 'âœ…' : 'âŒ'} *antiLink* ğŸ”—
${antiinsta ? 'âœ…' : 'âŒ'} *antiinsta* ğŸ“¸
${antielimina ? 'âœ…' : 'âŒ'} *antielimina* âœï¸
${antilinkhard ? 'âœ…' : 'âŒ'} *antilinkhard* â›“ï¸
${antiPrivate ? 'âœ…' : 'âŒ'} *antiPrivate* ğŸ”’
${antitraba ? 'âœ…' : 'âŒ'} *antitraba* ğŸš§
${antiviewonce ? 'âœ…' : 'âŒ'} *antiviewonce* ğŸ‘ï¸â€ğŸ—¨ï¸
${antitiktok ? 'âœ…' : 'âŒ'} *antitiktok* ğŸ¶
${antitelegram ? 'âœ…' : 'âŒ'} *antitelegram* âœˆï¸
${antiSpam ? 'âœ…' : 'âŒ'} *antiSpam* âœ‰ï¸
${antiPorno ? 'âœ…' : 'âŒ'} *antiPorno* ğŸ‘
${jadibot ? 'âœ…' : 'âŒ'} *jadibot* ğŸ¤–
${autosticker ? 'âœ…' : 'âŒ'} *autosticker* ğŸ–¼ï¸
${audios ? 'âœ…' : 'âŒ'} *audios* ğŸ”Š

â„¹ï¸ *Info sulle funzioni:*
âœ… Â» Funzione attivata
âŒ Â» Funzione disattivata

ğŸ› ï¸ *Uso del comando:*
âœ… Â» \`${usedPrefix}attiva [funzione]\`
âŒ Â» \`${usedPrefix}disabilita [funzione]\`

âš™ï¸ *Info sullo stato del bot:*
ğŸ” Â» \`${usedPrefix}infostato\`
`;

    // Invia il messaggio
    conn.sendMessage(m.chat, {
        text: menuText.trim(),
        contextInfo: {
            forwardingScore: 1,
            isForwarded: true,
            forwardedNewsletterMessageInfo: {
                newsletterJid: newsletterJid, // Il JID del canale
                serverMessageId: '', // Lascia vuoto
                newsletterName: botNewsletterName // Il nome che apparirÃ  come "mostra canale"
            },
            externalAdReply: {
                title: `âš™ï¸ Stato FunzionalitÃ  - ${conn.user.name || 'Bot'}`, // Titolo dell'embed
                body: `Tocca qui per saperne di piÃ¹!`, // Testo sotto il titolo dell'embed
                mediaType: 1, // Tipo di media (1 per immagine)
                renderLargerThumbnail: false, // Non renderizzare la thumbnail piÃ¹ grande
                previewType: "PHOTO", // Tipo di anteprima
                thumbnail: thumbnail, // La thumbnail scaricata
                sourceUrl: 'https://wa.me/' + conn.user.jid.split('@')[0] // Link del bot
            }
        }
    }); // Rimosso { quoted: fakeMessage }
};

handler.help = ["funzioni"];
handler.tags = ["main", "info"]; 
handler.command = /^(funzioni)$/i;

export default handler;
